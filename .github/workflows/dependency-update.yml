name: ðŸ“¦ Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of updates to perform'
        required: true
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - major
          - all

env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION_PATH: './Healthy/Healthy.sln'

jobs:
  check-updates:
    name: ðŸ” Check for Updates
    runs-on: ubuntu-latest
    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
      updates-summary: ${{ steps.check.outputs.updates-summary }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Install dotnet outdated tool
      run: dotnet tool install --global dotnet-outdated-tool

    - name: ðŸ” Check for outdated packages
      id: check
      run: |
        echo "ðŸ” Checking for outdated packages..."
        
        # Check for outdated packages
        if dotnet outdated ${{ env.SOLUTION_PATH }} --output json > outdated.json 2>/dev/null; then
          if [ -s outdated.json ] && [ "$(cat outdated.json)" != "[]" ]; then
            echo "has-updates=true" >> $GITHUB_OUTPUT
            
            # Create a summary of updates
            SUMMARY=$(cat outdated.json | jq -r '.[] | select(.outdated == true) | "- \(.name): \(.current) â†’ \(.latest)"' | head -20)
            if [ -n "$SUMMARY" ]; then
              echo "updates-summary<<EOF" >> $GITHUB_OUTPUT
              echo "$SUMMARY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "has-updates=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "âœ… All packages are up to date!"
          fi
        else
          echo "has-updates=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Could not check for updates"
        fi

    - name: ðŸ“¤ Upload outdated packages report
      uses: actions/upload-artifact@v4
      if: steps.check.outputs.has-updates == 'true'
      with:
        name: outdated-packages
        path: outdated.json
        retention-days: 7

  update-dependencies:
    name: ðŸ”„ Update Dependencies
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has-updates == 'true'
    
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Install dotnet outdated tool
      run: dotnet tool install --global dotnet-outdated-tool

    - name: ðŸ”„ Update packages
      run: |
        echo "ðŸ”„ Updating packages..."
        
        UPDATE_TYPE="${{ github.event.inputs.update_type || 'minor' }}"
        
        case $UPDATE_TYPE in
          "patch")
            dotnet outdated ${{ env.SOLUTION_PATH }} --upgrade --version-lock Major
            ;;
          "minor")
            dotnet outdated ${{ env.SOLUTION_PATH }} --upgrade --version-lock Minor
            ;;
          "major")
            dotnet outdated ${{ env.SOLUTION_PATH }} --upgrade
            ;;
          "all")
            dotnet outdated ${{ env.SOLUTION_PATH }} --upgrade
            ;;
        esac

    - name: ðŸ—ï¸ Build and test with updates
      run: |
        echo "ðŸ—ï¸ Building project with updated dependencies..."
        dotnet restore ${{ env.SOLUTION_PATH }}
        dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore
        
        echo "ðŸ§ª Running tests with updated dependencies..."
        dotnet test ${{ env.SOLUTION_PATH }} --configuration Release --no-build --logger trx --results-directory ./TestResults

    - name: ðŸ” Check for security vulnerabilities
      run: |
        echo "ðŸ” Checking for security vulnerabilities..."
        dotnet list ${{ env.SOLUTION_PATH }} package --vulnerable --include-transitive

    - name: ðŸ“ Generate update summary
      id: summary
      run: |
        echo "ðŸ“ Generating update summary..."
        
        # Get the changes made
        if git diff --quiet; then
          echo "No changes were made"
          echo "has-changes=false" >> $GITHUB_OUTPUT
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only | grep -E '\.(csproj|props|targets)$' | head -10)
          echo "changed-files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi

    - name: ðŸš€ Create Pull Request
      if: steps.summary.outputs.has-changes == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ðŸ“¦ Update dependencies - ${{ github.event.inputs.update_type || 'minor' }} updates"
        title: "ï¿½ Automated Dependency Update - ${{ github.event.inputs.update_type || 'minor' }} updates"
        body: |
          ## ï¿½ Automated Dependency Update
          
          This PR contains automated dependency updates for the Healthy System project.
          
          ### ðŸ”„ Update Type: ${{ github.event.inputs.update_type || 'minor' }}
          
          ### ðŸ“‹ Updated Packages
          ${{ needs.check-updates.outputs.updates-summary }}
          
          ### ðŸ” Changed Files
          ${{ steps.summary.outputs.changed-files }}
          
          ### âœ… Verification
          - [x] Build successful
          - [x] Tests passing
          - [x] Security vulnerabilities checked
          
          ### ðŸ¤– Automated Actions
          This PR was created automatically by the dependency update workflow.
          Please review the changes and merge if everything looks good.
          
          ### ðŸ“š Documentation
          - [Setup Guide](./README.SETUP.md)
          - [Project Documentation](./README.md)
        branch: dependencies/automated-update-${{ github.run_number }}
        delete-branch: true
        labels: |
          dependencies
          automated
          enhancement

  security-audit:
    name: ðŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    if: always()
    
    permissions:
      security-events: write

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ”„ Restore packages
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: ðŸ›¡ï¸ Run security audit
      run: |
        echo "ðŸ›¡ï¸ Running security audit..."
        dotnet list ${{ env.SOLUTION_PATH }} package --vulnerable --include-transitive 2>&1 | tee security-audit.log
        
        # Check if vulnerabilities were found
        if grep -q "has the following vulnerable packages" security-audit.log; then
          echo "âš ï¸ Security vulnerabilities found!"
          echo "## ðŸš¨ Security Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following vulnerable packages were detected:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -A 20 "has the following vulnerable packages" security-audit.log >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… No security vulnerabilities found"
          echo "## âœ… Security Audit Passed" >> $GITHUB_STEP_SUMMARY
          echo "No security vulnerabilities were found in the project dependencies." >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ“¤ Upload security audit results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-audit-${{ github.run_number }}
        path: security-audit.log
        retention-days: 30

  notify-completion:
    name: ðŸ“¢ Notify Completion
    runs-on: ubuntu-latest
    needs: [check-updates, update-dependencies, security-audit]
    if: always()
    
    steps:
    - name: ðŸ“‹ Workflow Summary
      run: |
        echo "## ðŸ“¦ Dependency Update Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Results:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” Updates Available: ${{ needs.check-updates.outputs.has-updates == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ Dependencies Updated: ${{ needs.update-dependencies.result == 'success' && 'âœ… Success' || needs.update-dependencies.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ›¡ï¸ Security Audit: ${{ needs.security-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.check-updates.outputs.has-updates }}" == "true" ]; then
          echo "### ðŸ“¦ Available Updates:" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.check-updates.outputs.updates-summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created with the dependency updates." >> $GITHUB_STEP_SUMMARY
        else
          echo "### âœ… All dependencies are up to date!" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "- Review any created pull requests" >> $GITHUB_STEP_SUMMARY
        echo "- Check security audit results" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor build and test results" >> $GITHUB_STEP_SUMMARY 